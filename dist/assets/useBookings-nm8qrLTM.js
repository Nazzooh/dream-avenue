import{s as n,g as k,f as _,q as p,t as l}from"./index-BgtLIF6L.js";import{l as i}from"./logger-DwKo-Kyg.js";async function y(e){i.info("getBookings",e);let a=n.from("bookings").select("*");const{data:o,error:t}=await a.order("booking_date",{ascending:!1});if(t)throw i.error("getBookings failed",t),t;return o}const r={all:["bookings"],lists:()=>[...r.all,"list"],list:e=>[...r.lists(),e],details:()=>[...r.all,"detail"],detail:e=>[...r.details(),e]};async function U({bookingId:e,eventType:a,packageId:o,timeSlot:t,startTime:c,endTime:d,adminPriceAdjustment:u,specialRequests:s,adminId:m}){console.log("[API] Calling admin_update_booking_details RPC",{bookingId:e,eventType:a,packageId:o,timeSlot:t,startTime:c,endTime:d,adminPriceAdjustment:u,specialRequests:s,adminId:m});const{data:f,error:g}=await n.rpc("admin_update_booking_details",{p_booking_id:e,p_event_type:a,p_package_id:o,p_time_slot:t,p_start_time:c||null,p_end_time:d||null,p_admin_price_adjustment:Number(u)||0,p_special_requests:s||"",p_admin_id:m});if(g)throw console.error("[API] admin_update_booking_details RPC ERROR:",g),g;return f}async function w(e,a){i.info("adminCancelBooking",{p_booking_id:e,p_admin_id:a});const{data:o,error:t}=await n.rpc("admin_cancel_booking",{p_booking_id:e,p_admin_id:a});if(t)throw i.error("admin_cancel_booking rpc error",t),t;return o}async function C({bookingId:e,adminId:a}){const{data:o,error:t}=await n.rpc("admin_confirm_booking",{p_booking_id:e,p_admin_id:a});if(t)throw t;return o}async function B(e,a){i.info("adminUpdateBookingStatus",{bookingId:e,status:a});const{data:o,error:t}=await n.from("bookings").update({status:a}).eq("id",e).select().single();if(t)throw i.error("adminUpdateBookingStatus failed",t),t;return o}async function b(e){i.info("adminDeleteBooking",{bookingId:e});const{error:a}=await n.from("bookings").delete().eq("id",e);if(a)throw i.error("adminDeleteBooking failed",a),a;return{success:!0}}async function q({p_booking_id:e,p_admin_id:a,p_cooking_gas_qty:o,p_garbage_bags:t,p_plates_large:c,p_plates_small:d}){i.info("adminUpdateExtras",{p_booking_id:e});const{data:u,error:s}=await n.rpc("admin_update_extras",{p_booking_id:e,p_admin_id:a,p_cooking_gas_qty:o,p_garbage_bags:t,p_plates_large:c,p_plates_small:d});if(s)throw i.error("admin_update_extras rpc error",s),s;return u}async function v(e,a){i.info("adminUpdateBookingExtras",{bookingId:e,extras:a});const{data:{user:o}}=await n.auth.getUser();if(!o)throw new Error("Not authenticated");return q({p_booking_id:e,p_admin_id:o.id,p_cooking_gas_qty:a.cooking_gas_qty,p_garbage_bags:a.garbage_bags,p_plates_large:a.plates_large,p_plates_small:a.plates_small})}async function K(e){console.log("[API] getBookingActions bookingId:",e);const{data:a,error:o}=await n.rpc("get_booking_actions",{p_booking_id:e});if(o)throw o;return a}const Q=e=>k({queryKey:r.list(e),queryFn:()=>y(e)}),F=()=>{const e=_();return p({mutationFn:({id:a,status:o})=>B(a,o),onSuccess:()=>{e.invalidateQueries({queryKey:r.all}),e.invalidateQueries({queryKey:["admin_events"]}),e.invalidateQueries({queryKey:["availability"]}),l.success("Booking status updated")},onError:a=>{l.error(a.message||"Failed to update booking status")}})},D=()=>{const e=_();return p({mutationFn:a=>b(a),onSuccess:()=>{e.invalidateQueries({queryKey:r.all}),l.success("Booking deleted successfully")},onError:a=>{l.error(a.message||"Failed to delete booking")}})},S=()=>{const e=_();return p({mutationFn:async a=>{const{data:{user:o}}=await n.auth.getUser();if(!o)throw new Error("Not authenticated");const{data:t}=await n.from("profiles").select("id, role").eq("id",o.id).single();if(!t||t.role!=="admin")throw new Error("Admin access required");return w(a,t.id)},onSuccess:()=>{e.invalidateQueries({queryKey:r.all}),e.invalidateQueries({queryKey:["calendar_availability"]}),l.success("Booking cancelled successfully. Date released to calendar.")},onError:a=>{l.error(a.message||"Failed to cancel booking")}})};export{S as a,D as b,F as c,U as d,v as e,C as f,K as g,Q as u};
