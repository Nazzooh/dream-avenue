import{s as i,_ as C,o as m,i as h,n as b,a as g,h as y,j as w,b as _,u as k,c as v}from"./index-DCvhesIs.js";import{l as o}from"./logger-DwKo-Kyg.js";import{t as f}from"./vendor-ui-Bvf1z7Qk.js";async function E(t,e){console.log(`[Calendar API] Fetching calendar for ${t}-${e}`),o.info("[Calendar API] Fetching month:",t,e);try{const a={p_month:e,p_year:t},{data:r,error:n}=await i.rpc("get_calendar_month",a);if(n)throw console.error("[Calendar API] get_calendar_month RPC Error:",{code:n.code,message:n.message,details:n.details,payload:a}),o.error("[Calendar API] get_calendar_month RPC Error:",n,{year:t,month:e}),new Error(`Failed to load calendar: ${n.message}`);return console.log("[Calendar API] raw data",r),o.debug("[Calendar API] raw data:",r),r}catch(a){throw o.error("[Calendar API] fetchCalendarMonth - EXCEPTION:",a),a}}async function P(t,e){o.info("[Calendar API] fetchCalendarEvents",{startDate:t,endDate:e});const a={p_start:t,p_end:e},{data:r,error:n}=await i.rpc("get_calendar_events",a);if(n)throw console.error("[Calendar API] get_calendar_events RPC Error:",n),o.error("[Calendar API] fetchCalendarEvents failed",n),n;return r}async function D(t,e){console.log("[Public Calendar] Fetching",t,e);try{const{data:s,error:c}=await i.rpc("get_calendar_month",{p_year:t,p_month:e});if(!c&&s)return console.log("[Public Calendar] RPC result",s),s;c&&console.warn("[Public Calendar] RPC failed",c)}catch(s){console.warn("[Public Calendar] RPC exception",s)}const a=`${t}-${String(e).padStart(2,"0")}-01`,r=`${t}-${String(e).padStart(2,"0")}-32`,{data:n,error:u}=await i.from("public_availability").select("*").gte("date",a).lt("date",r);if(u)throw console.error("[Public Calendar] View fetch error",u),u;const d={};return(n||[]).forEach(s=>{const c=s.date?.toString().slice(0,10);d[c]={full_day:!!s.full_day,morning:!!s.morning,evening:!!s.evening,night:!!s.night,short_duration:!!s.short_duration}}),console.log("[Public Calendar] normalized view data",d),d}const q=async t=>{const{data:e,error:a}=await i.from("events").insert([{event_name:`Blocked: ${t.reason||"Manual Block"}`,event_type:"blocked",event_date:t.date,status:"blocked",description:t.reason||"Date manually blocked by admin"}]).select().single();if(a)throw new Error(a.message);return e&&await i.from("booking_actions").insert([{booking_id:null,admin_id:t.admin_id,action:"block_date",notes:`Blocked date: ${t.date}. Reason: ${t.reason||"No reason provided"}`}]),e},F=async(t,e)=>{const{data:a,error:r}=await i.from("events").select("*").eq("event_date",t).eq("event_type","blocked").eq("status","blocked").single();if(r&&r.code!=="PGRST116")throw new Error(r.message);if(!a)throw new Error("No blocked event found for this date");const{error:n}=await i.from("events").delete().eq("id",a.id);if(n)throw new Error(n.message);return await i.from("booking_actions").insert([{booking_id:null,admin_id:e,action:"unblock_date",notes:`Unblocked date: ${t}`}]),{success:!0}},M=async t=>{const e={full_name:t.full_name,mobile:t.mobile,email:t.email||null,guest_count:t.guest_count||0,event_type:t.event_type||"other",package_id:t.package_id||null,special_requests:t.special_requests||null,additional_notes:t.additional_notes||null,booking_date:t.booking_date,status:t.status||"confirmed"};t.time_slot==="short_duration"?(e.start_time=t.start_time||"10:00",e.end_time=t.end_time||"14:00"):t.time_slot==="morning"?(e.start_time="10:00",e.end_time="14:00"):t.time_slot==="evening"?(e.start_time="14:00",e.end_time="18:00"):t.time_slot==="night"?(e.start_time="18:00",e.end_time="22:00"):t.time_slot==="full_day"&&(e.start_time="10:00",e.end_time="18:00");const{data:a,error:r}=await i.from("bookings").insert([e]).select().single();if(r)throw new Error(r.message);return a},B=C(["available","partial","full"]);m({date:g(),bookings:b().default(0),totalGuests:b().default(0),status:B,timeSlots:h(m({start:g(),end:g(),guests:b().optional()})).optional()});const $=m({date:g().min(1,"Date is required"),available:y(),hasConflict:y(),existingBookings:b(),bookings:h(w()),message:g()}),A=async t=>{const{data:e,error:a}=await i.from("events").select("*").eq("event_date",t.date);if(a)throw new Error(a.message);const r=e||[],n=r.length,u=r.some(c=>c.slot==="full_day");let d=!u&&n<4,s=d?"Date is available for booking":u?"Date is fully booked (full day event)":"Date is fully booked (all slots taken)";return $.parse({date:t.date,isAvailable:d,bookingsCount:n,totalGuests:0,message:s})},l={all:["calendar"],months:()=>[...l.all,"months"],month:(t,e)=>[...l.months(),t,e],events:()=>[...l.all,"events"],eventsByRange:(t,e)=>[...l.events(),t,e]};function R(t,e){return _({queryKey:l.month(t,e),queryFn:async()=>{o.info(`[useCalendarMonth] Querying ${t}-${e}`);const a=await E(t,e);return!a||Object.keys(a).length===0?(console.warn("[useCalendarMonth] RPC returned empty, using public fallback"),await D(t,e)):a},retry:2,retryDelay:a=>Math.min(1e3*2**a,5e3),staleTime:1e3*60*5})}function K(t,e){return _({queryKey:l.eventsByRange(t,e),queryFn:async()=>(o.info(`[useCalendarEvents] Querying events from ${t} to ${e}`),await P(t,e)),retry:2,retryDelay:a=>Math.min(1e3*2**a,5e3),staleTime:1e3*60*2})}function Q(){const t=k();return v({mutationFn:async e=>(o.info("[useBlockDate] Blocking date",e),await q(e)),onSuccess:(e,a)=>{o.info("[useBlockDate] Date blocked successfully",e),f.success("Date blocked successfully"),t.invalidateQueries({queryKey:l.all})},onError:e=>{o.error("[useBlockDate] Failed to block date",e),f.error(e.message||"Failed to block date")}})}function U(){const t=k();return v({mutationFn:async({date:e,admin_id:a})=>(o.info("[useUnblockDate] Unblocking date",{date:e,admin_id:a}),await F(e,a)),onSuccess:(e,a)=>{o.info("[useUnblockDate] Date unblocked successfully",e),f.success("Date unblocked successfully"),t.invalidateQueries({queryKey:l.all})},onError:e=>{o.error("[useUnblockDate] Failed to unblock date",e),f.error(e.message||"Failed to unblock date")}})}function T(){const t=k();return v({mutationFn:async e=>(o.info("[useCreateManualBooking] Creating manual booking",e),await M(e)),onSuccess:(e,a)=>{o.info("[useCreateManualBooking] Manual booking created successfully",e),f.success("Manual booking created successfully"),t.invalidateQueries({queryKey:l.all}),t.invalidateQueries({queryKey:["bookings"]})},onError:e=>{o.error("[useCreateManualBooking] Failed to create manual booking",e),f.error(e.message||"Failed to create manual booking")}})}function j(t,e=!0){return _({queryKey:["availability","date",t],queryFn:async()=>t?(o.info(`[useAvailabilityForDate] Checking availability for ${t}`),await A({date:t})):null,enabled:e&&!!t,retry:2,retryDelay:a=>Math.min(1e3*2**a,5e3),staleTime:1e3*60*2})}export{j as a,T as b,K as c,Q as d,U as e,R as u};
